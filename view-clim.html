<!-- Contenuto CLIM aggiornato -->
<div class="page" id="clim-root">

  <div id="gsWarn">⚠️ Cette page n’est pas servie par Apps Script (google.script.run indisponible). Ouvrez l’URL de la <b>Web App</b> déployée, ou intégrez <em>l’URL de la Web App</em> dans Google Sites.</div>

  <!-- MH -->
  <section class="card" id="mhCard">
    <div class="card-header"><h2>MH</h2></div>
    <div class="card-content">
      <div class="mhRow">
        <!-- Radios facoltativi (per lavoro senza login) -->
        <div class="radios" id="quiRadios" aria-label="Qui">
          <label><input type="radio" name="person" value="Alain"> Alain</label>
          <label><input type="radio" name="person" value="Vasko"> Vasko</label>
        </div>
        <!-- Selettore MH -->
        <select id="mhSelect" aria-label="n° MH" disabled>
          <option value="">Chargement…</option>
        </select>
      </div>
    </div>
  </section>

  <div class="actions">
    <div class="status" id="status">Prêt.</div>
    <button class="btn" id="submitBtn" type="button" disabled>Envoyer</button>
  </div>
</div>

<script>
(function(){
  const root = document.getElementById('clim-root');
  const statusEl  = root.querySelector('#status');
  const submitEl  = root.querySelector('#submitBtn');
  const mhSelect  = root.querySelector('#mhSelect');
  const radiosBox = root.querySelector('#quiRadios');
  const gsWarn    = document.getElementById('gsWarn');

  const state = { who:'', mh:'' };

  // Se login già presente, imposta who e nascondi i radio
  if (window.APP && APP.user && APP.user.name) {
    state.who = APP.user.name;
    if (radiosBox) radiosBox.style.display = 'none';
  }

  // ✅ Reagisci ai cambi di login/logout
  document.addEventListener('userchange', (ev)=>{
    const u = ev.detail && ev.detail.user;
    state.who = (u && u.name) ? u.name : '';
    if (radiosBox) radiosBox.style.display = (u && u.name) ? 'none' : '';
    validate();
  });

  function setStatus(msg, ok){
    statusEl.textContent = msg || '';
    statusEl.style.color = ok ? '#0b6e4f' : '#9b2226';
  }

  // ✅ Abilita il submit solo con MH selezionato (radio non obbligatorio)
  function validate(){
    submitEl.disabled = !state.mh;
  }

  function populateMH(list){
    mhSelect.innerHTML = '<option value="">Sélectionnez n° MH…</option>';
    (list||[]).forEach(opt=>{
      const o = document.createElement('option');
      o.value = opt.value; o.textContent = opt.label;
      mhSelect.appendChild(o);
    });
    mhSelect.disabled = false;
    if (state.mh) {
      mhSelect.value = state.mh;
      if (mhSelect.value !== state.mh) state.mh = '';
    }
    validate();
  }

  function loadMH(){
    if (!(window.google && google.script && google.script.run)) {
      gsWarn.style.display = 'block';
      mhSelect.disabled = false;
      setStatus('google.script.run indisponible', false);
      return;
    }
    mhSelect.disabled = true;
    mhSelect.innerHTML = '<option value="">Chargement…</option>';
    google.script.run
      .withSuccessHandler(list => { populateMH(list); setStatus('Prêt.', true); })
      .withFailureHandler(err => { console.error(err); setStatus('Erreur chargement MH.', false); mhSelect.disabled = false; validate(); })
      .getMhOptions(); // Nome esatto dal Code.gs
  }

  // Radio (se usati senza login)
  radiosBox.addEventListener('change', (e)=>{
    if (e.target && e.target.name === 'person') { state.who = e.target.value; validate(); }
  });

  // MH
  mhSelect.addEventListener('change', ()=>{
    state.mh = mhSelect.value.trim();
    validate();
  });

  // Submit con fallback nome da login
  submitEl.addEventListener('click', ()=>{
    if (!(window.google && google.script && google.script.run)) {
      setStatus('Envoyez via la Web App Apps Script.', false); return;
    }
    if (submitEl.disabled) return;

    submitEl.disabled = true;
    setStatus('Enregistrement…', true);

    const who = state.who || (window.APP && APP.user && APP.user.name) || '';

    const payload = { person: who, mh: state.mh };
    google.script.run
      .withSuccessHandler(()=>{
        setStatus('✅ Enregistré', true);
        state.mh = '';
        mhSelect.value = '';
        loadMH();
        window.scrollTo({ top:0, behavior:'smooth' });
        validate();
      })
      .withFailureHandler(err=>{
        console.error(err);
        setStatus('Erreur: '+(err && err.message ? err.message : err), false);
        validate();
      })
      .submitForm(payload);
  });

  // Init
  (function init(){
    setStatus('Prêt.', true);
    loadMH();
    validate();
  })();
})();
</script>
